<!DOCTYPE html>

<html>
<head>
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
        }
        body.dots {
            background-image: radial-gradient(lightcoral 20%, transparent 20%),
                radial-gradient(lightcoral 20%, transparent 20%);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }
        h1 {
            font-family: 'Libre Baskerville', serif;
            font-size: 36pt;
            text-align: center;
        }
        svg {
            display: block;
            margin: auto;
        }
        .bars rect {
            fill: lightgrey;
        }
        .bars rect:last-child {
            fill: lightcoral;
        }
        .bars rect:hover {
            fill: black;
        }

        div.tooltip {	
            position: absolute;			
            text-align: left;	
            width: 160px;					
            height: 90px;					
            padding: 10px;				
            font: 18px;		
            background: white;
            border: 1px;				
            pointer-events: none;			
        }
    </style>
</head>
<body onload="init()">
    <div id="article">
        
        <button onclick="bubbleChart(1)">Next</button>
        <h1>150,000 Lost and Counting</h1>
        <div id="article">
            <p>
                As the coronavirus outbreak spreads in the United States, the death toll continues to climb. While the growing number of deaths are clearly communicated with figures and charts similar to the one displayed here, it's easy to forget the magnitude of the number of lives we've lost and the impact each death had on close friends and family. This is an attempt to bring those themes to the forefront.
            </p>
        </div>
        <div id="dataviz-1"></div>
    </div>
</body>
<script>
    async function init() {
        data = await d3.csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us.csv")

        var margin = {top: 50, right: 50, bottom: 50, left: 50},
            width = window.innerWidth - margin.left - margin.right,
            height = window.innerHeight - margin.top - margin.bottom - 150;

        var svg = d3.select("#dataviz-1")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .classed("bars", true)
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var dataCopy = [...data];
        var lastObject = dataCopy.pop();
        var lastDate = new Date(lastObject.date);

        var x = d3.scaleTime()
            .domain([new Date("2020-01-21"), lastDate.setDate(lastDate.getDate() + 1)])
            .range([0, width]);

        var y = d3.scaleLinear()
            .domain([0,200000])
            .range([0,height]);

        // define the div for the tooltip
        var div = d3.select("body").append("div")	
            .attr("class", "tooltip")				
            .style("opacity", 0);


        // inverted bar chart
        svg.selectAll("rect")
        .data(data)
        .enter()
        .append("rect")
        .attr("x", function (d,i) {return x(new Date(d.date));})
        .attr("width", 5)
        .attr("height", function (d,i) {return y(0);})
        // .attr("height", function (d,i) {return y(d.deaths);})
        .on("mouseover", function(d) {		
            div.transition().duration(10).style("opacity", .7);		
            div.html("<p class='date'>" +d.date + "</p>" + "<p>Total Deaths:  " + d.deaths + "</p>")	
                .style("left", (d3.event.pageX) - 190 + "px")		
                .style("top", (d3.event.pageY - 10) + "px");	
            })					
        .on("mouseout", function(d) {		
            div.transition().duration(100).style("opacity", 0);	
        });


        xaxis = d3.axisTop(x).tickFormat(d3.timeFormat("%B"));
        yaxis = d3.axisLeft(y).tickValues([0,50000,100000,150000,200000]).tickFormat(d3.format("~s"))
        y2axis = d3.axisRight(y).tickValues([0,50000,100000,150000,200000]).tickFormat(d3.format("~s"));


        svg = d3.select("svg");
        
        svg.append("g")
        .attr("transform", "translate("+(width+margin.left)+","+margin.top+")")
        .call(y2axis);

        svg.append("g")
        .attr("transform", "translate("+margin.left+","+margin.top+")")
        .call(xaxis);

        // animation
        svg.selectAll("rect")
        .transition()
        .duration(800)
        .attr("y", function(d) { return y(d.Value); })
        .attr("height", function(d) { return y(d.deaths); })


        // annotate bar chart
        const annotations = [{
            note: {
                label: lastObject.deaths,
                bgPadding: 20,
                title: "Deaths"
            },
            x: x(lastDate) + margin.left - 3,
            y: y(lastObject.deaths) + margin.top + 3,
            dy: 20,
            dx: -30
        }]

        // Add annotation to the chart
        const makeAnnotations = d3.annotation().annotations(annotations)

        svg.append("g").call(makeAnnotations);
    }

    function bubbleChart(deaths) {
        var margin = {top: 0, right: 0, bottom: 0, left: 0},
            width = window.innerWidth - margin.left - margin.right,
            height = window.innerHeight - margin.top - margin.bottom;
        
        if (deaths == 1) {
            d3.select("#dataviz-1").html("");
            d3.select("button").attr("onclick", "bubbleChart(14000)")

            var svg = d3.select("#dataviz-1")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .classed("bubble", true)
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var data = new Array(deaths).fill(
                {"name": "Carl Redd, 62, Chicago", 
                "moment": "Squeezed in every moment he could with his only grandchild", 
                "deaths": 1}
            );
           
        } else {
            var svg = d3.select("svg").select("g");
            var data = new Array(deaths).fill({"name": "covid", "moment": "human", "deaths": 1})
        }

        data = {"children": data}

        var bubble = d3.pack(data)
            .size([width, height])
            .padding(3);

        redraw(data);

        // var interval = d3.interval(function(elapsed){
        //     deaths = 140000 / 10;
        //     data = new Array(deaths).fill({"name": "covid", "deaths": 1});
        //     data = {"children": data};
        //     redraw(data)

        //     if (elapsed > 100) {
        //         interval.stop();
        //         return;
        //     }
        // }, 800);

        function redraw(data) {
            // transition
            var t = d3.transition()
                .duration(1050);

            // hierarchy
            var nodes = d3.hierarchy(data)
                .sum(function(d) { return d.deaths; });

            // join
            var node = svg.selectAll("circle")
                .data(bubble(nodes).leaves());

            var text = svg.selectAll("text")
                .data(bubble(nodes).leaves(), function(d) { return d.name; });

            // update
            node.transition(t)
                .style("fill", "black")
                .attr("r", function(d){ return d.r })
                .attr("cx", function(d){ return d.x; })
                .attr("cy", function(d){ return d.y; })

            text.remove();

            // exit
            node.exit()
                .style("fill", "lightcoral")
                .transition(t)
                .attr("r", 1e-6)
                .remove();

            text.exit().remove();

            // enter
            node.enter().append("circle")
                .style("fill", "lightcoral")
                .attr("r", function(d){ return d.r })
                .attr("cx", function(d){ return d.x; })
                .attr("cy", function(d){ return d.y; });

            var annotations = [{
                note: {
                    label: 14000,
                    bgPadding: 20,
                    title: "Deaths"
                },
                x: width / 4,
                y: 80,
                dy: -20,
                dx: -30
            }];

            if (deaths == 1) {
                text.enter().append("text")
                    .attr("dy", ".2em")
                    .attr("opacity", 1e-6)
                    .style("text-anchor", "middle")
                    .style("font-size", "36px")
                    .style("font-family", "Libre Baskerville, serif")
                    .style("fill", "white")
                    .attr("x", function(d){ return d.x; })
                    .attr("y", function(d){ return d.y; })
                    .text(function(d){ return d.data.name; })
                    .transition(t)
                    .attr("opacity", 1);

                text.enter().append("text")
                    .attr("dy", "2.0em")
                    .attr("opacity", 1e-6)
                    .style("text-anchor", "middle")
                    .style("fill", "white")
                    .attr("x", function(d){ return d.x; })
                    .attr("y", function(d){ return d.y; })
                    .text(function(d){ return d.data.moment; })
                    .transition(t)
                    .attr("opacity", 1);

                annotations = [{
                    note: {
                        label: 1,
                        bgPadding: 20,
                        title: "Deaths"
                    },
                    x: width / 4,
                    y: 80,
                    dy: -20,
                    dx: -30
                }]
            }

            // Add annotation to the chart
            var makeAnnotations = d3.annotation().annotations(annotations)
            svg.append("g").call(makeAnnotations);
        }
    }
</script>
</html>